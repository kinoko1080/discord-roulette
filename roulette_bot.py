# ============================================
# Discord ãƒ­ã‚·ã‚¢ãƒ³ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆãƒœãƒƒãƒˆ
# ============================================
# Pythonã§ãƒ‡ã‚£ã‚¹ã‚³ãƒ¼ãƒ‰ã®ãƒœãƒƒãƒˆã‚’ä½œæˆã™ã‚‹ãŸã‚ã«å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã¿

# Discord.pyãƒ©ã‚¤ãƒ–ãƒ©ãƒª - Discordã®ãƒœãƒƒãƒˆã‚’ä½œã‚‹ãŸã‚ã®ãƒ¡ã‚¤ãƒ³ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
import discord
from discord.ext import commands  # ã‚³ãƒãƒ³ãƒ‰æ©Ÿèƒ½ã‚’ä½¿ã†ãŸã‚
from discord import app_commands  # ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰æ©Ÿèƒ½ã‚’ä½¿ã†ãŸã‚

# ãã®ä»–ã®å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒª
import random   # ãƒ©ãƒ³ãƒ€ãƒ ãªæ•°å­—ã‚„é †ç•ªã‚’ç”Ÿæˆã™ã‚‹ãŸã‚
import asyncio  # éåŒæœŸå‡¦ç†ï¼ˆæ™‚é–“ã‚’ã‹ã‘ã¦å®Ÿè¡Œã™ã‚‹å‡¦ç†ï¼‰ã‚’è¡Œã†ãŸã‚
import os       # ç’°å¢ƒå¤‰æ•°ï¼ˆè¨­å®šæƒ…å ±ï¼‰ã‚’èª­ã¿å–ã‚‹ãŸã‚
from dotenv import load_dotenv  # .envãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã‚€ãŸã‚

# ============================================
# åˆæœŸè¨­å®š
# ============================================

# ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã¿ï¼ˆ.envãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼‰
load_dotenv()

# ãƒœãƒƒãƒˆã®è¨­å®š
# Intentsã¯ãƒœãƒƒãƒˆãŒã©ã‚“ãªæƒ…å ±ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹ã‚’æ±ºã‚ã‚‹è¨­å®š
intents = discord.Intents.default()  # åŸºæœ¬çš„ãªæ©Ÿèƒ½ã‚’ä½¿ç”¨
# ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰å°‚ç”¨ãƒœãƒƒãƒˆãªã®ã§ã€message_contentã‚¤ãƒ³ãƒ†ãƒ³ãƒˆã¯ä¸è¦
# intents.message_content = True  # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å†…å®¹ã‚’èª­ã¿å–ã‚‹æ¨©é™ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰

# ãƒœãƒƒãƒˆã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆå®Ÿä½“ï¼‰ã‚’ä½œæˆ
# command_prefix=None ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚³ãƒãƒ³ãƒ‰ã¯ä½¿ã‚ãªã„ï¼ˆã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã®ã¿ï¼‰
bot = commands.Bot(command_prefix=None, intents=intents)

# ============================================
# ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚²ãƒ¼ãƒ ã®ã‚¯ãƒ©ã‚¹ï¼ˆè¨­è¨ˆå›³ï¼‰
# ============================================

class RouletteGame:
    """
    ãƒ­ã‚·ã‚¢ãƒ³ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚²ãƒ¼ãƒ ã‚’ç®¡ç†ã™ã‚‹ã‚¯ãƒ©ã‚¹
    ã“ã®ã‚¯ãƒ©ã‚¹ã§ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚„é€²è¡Œã‚’ç®¡ç†ã—ã¾ã™
    """
    
    def __init__(self):
        """
        ã‚²ãƒ¼ãƒ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆæœŸåŒ–ã™ã‚‹é–¢æ•°
        æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’ä½œã‚‹ã¨ãã«æœ€åˆã«å®Ÿè¡Œã•ã‚Œã‚‹
        """
        self.players = []           # å‚åŠ è€…ã®ãƒªã‚¹ãƒˆï¼ˆç©ºã®çŠ¶æ…‹ã‹ã‚‰é–‹å§‹ï¼‰
        self.is_active = False      # ã‚²ãƒ¼ãƒ ãŒé€²è¡Œä¸­ã‹ã©ã†ã‹ï¼ˆFalse = åœæ­¢ä¸­ï¼‰
        self.current_chamber = 0    # ç¾åœ¨ä½•ç™ºç›®ã‚’æ’ƒã£ãŸã‹ï¼ˆ0ã‹ã‚‰é–‹å§‹ï¼‰
        self.bullet_chamber = 0     # å®Ÿå¼¾ãŒå…¥ã£ã¦ã„ã‚‹ãƒãƒ£ãƒ³ãƒãƒ¼ã®ä½ç½®
        self.max_chambers = 6       # ãƒªãƒœãƒ«ãƒãƒ¼ã®å¼¾å€‰æ•°ï¼ˆ6ç™ºï¼‰
        
    def start_game(self, participants):
        """
        ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã™ã‚‹é–¢æ•°
        å‚åŠ è€…ãƒªã‚¹ãƒˆã‚’ã‚‚ã¨ã«ã‚²ãƒ¼ãƒ ã®æº–å‚™ã‚’ã™ã‚‹
        """
        self.players = participants.copy()  # å‚åŠ è€…ãƒªã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ä¿å­˜
        self.is_active = True                # ã‚²ãƒ¼ãƒ é–‹å§‹ãƒ•ãƒ©ã‚°ã‚’ã‚ªãƒ³ã«ã™ã‚‹
        self.current_chamber = 0             # æ’ƒã£ãŸå›æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
        
        # 1ã€œ6ã®ã©ã“ã«å®Ÿå¼¾ãŒã‚ã‚‹ã‹ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«æ±ºã‚ã‚‹
        self.bullet_chamber = random.randint(1, self.max_chambers)
        
        # ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é †ç•ªã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆå…¬å¹³æ€§ã®ãŸã‚ï¼‰
        random.shuffle(self.players)
        
    def pull_trigger(self):
        """
        å¼•ãé‡‘ã‚’å¼•ãé–¢æ•°
        å®Ÿå¼¾ã‹ã©ã†ã‹ã‚’åˆ¤å®šã—ã¦çµæœã‚’è¿”ã™
        """
        self.current_chamber += 1  # æ’ƒã£ãŸå›æ•°ã‚’1å¢—ã‚„ã™
        
        # ç¾åœ¨ã®ãƒãƒ£ãƒ³ãƒãƒ¼ãŒå®Ÿå¼¾ã®ä½ç½®ã¨åŒã˜ã‹ãƒã‚§ãƒƒã‚¯
        return self.current_chamber == self.bullet_chamber
        
    def reset(self):
        """
        ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹é–¢æ•°
        ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚ã‚„å¼·åˆ¶åœæ­¢æ™‚ã«å‘¼ã³å‡ºã•ã‚Œã‚‹
        """
        self.players = []           # å‚åŠ è€…ãƒªã‚¹ãƒˆã‚’ç©ºã«ã™ã‚‹
        self.is_active = False      # ã‚²ãƒ¼ãƒ åœæ­¢ãƒ•ãƒ©ã‚°ã‚’ã‚ªãƒ³ã«ã™ã‚‹
        self.current_chamber = 0    # æ’ƒã£ãŸå›æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
        self.bullet_chamber = 0     # å®Ÿå¼¾ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ

# ============================================
# ã‚²ãƒ¼ãƒ ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆå®Ÿä½“ï¼‰ã‚’ä½œæˆ
# ============================================
# ã“ã®gameã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§å…¨ã¦ã®ã‚²ãƒ¼ãƒ é€²è¡Œã‚’ç®¡ç†ã™ã‚‹
game = RouletteGame()

# ============================================
# ãƒœãƒƒãƒˆã®ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†
# ============================================

@bot.event
async def on_ready():
    """
    ãƒœãƒƒãƒˆãŒDiscordã«æ¥ç¶šå®Œäº†ã—ãŸã¨ãã«å®Ÿè¡Œã•ã‚Œã‚‹é–¢æ•°
    ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã®åŒæœŸã‚‚ã“ã“ã§è¡Œã†
    """
    print(f'{bot.user} ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸï¼')
    print(f'ãƒœãƒƒãƒˆID: {bot.user.id}')
    print('ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã®åŒæœŸã‚’é–‹å§‹...')
    
    # ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã‚’åŒæœŸï¼ˆDiscordã‚µãƒ¼ãƒãƒ¼ã«ç™»éŒ²ï¼‰
    try:
        guild_id = os.getenv('GUILD_ID')  # .envãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚®ãƒ«ãƒ‰IDã‚’å–å¾—
        print(f'GUILD_IDç’°å¢ƒå¤‰æ•°: {guild_id}')
        
        if guild_id and guild_id != 'your_guild_id_here':
            # ç‰¹å®šã®ã‚µãƒ¼ãƒãƒ¼ï¼ˆã‚®ãƒ«ãƒ‰ï¼‰ã«ã®ã¿åŒæœŸï¼ˆé–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç”¨ï¼‰
            # ã“ã®æ–¹æ³•ã ã¨å³åº§ã«åæ˜ ã•ã‚Œã‚‹
            print(f'ã‚®ãƒ«ãƒ‰ {guild_id} ã¸ã®åŒæœŸã‚’å®Ÿè¡Œä¸­...')
            guild = discord.Object(id=int(guild_id))
            synced = await bot.tree.sync(guild=guild)
            print(f'âœ… ã‚®ãƒ«ãƒ‰ {guild_id} ã«åŒæœŸã•ã‚ŒãŸã‚³ãƒãƒ³ãƒ‰æ•°: {len(synced)}')
        else:
            # ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒæœŸï¼ˆå…¨ã¦ã®ã‚µãƒ¼ãƒãƒ¼ã§ä½¿ç”¨å¯èƒ½ï¼‰
            # ã“ã®æ–¹æ³•ã ã¨åæ˜ ã«æœ€å¤§1æ™‚é–“ã‹ã‹ã‚‹
            print('ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒæœŸã‚’å®Ÿè¡Œä¸­...')
            synced = await bot.tree.sync()
            print(f'âœ… ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«åŒæœŸã•ã‚ŒãŸã‚³ãƒãƒ³ãƒ‰æ•°: {len(synced)}')
            print('âš ï¸  ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒæœŸã¯åæ˜ ã«æœ€å¤§1æ™‚é–“ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™')
            
    except Exception as e:
        # ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã®å‡¦ç†
        print(f'âŒ ã‚³ãƒãƒ³ãƒ‰åŒæœŸã‚¨ãƒ©ãƒ¼: {e}')
        import traceback
        traceback.print_exc()  # è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
    
    print('------')
    print('ğŸ¯ ãƒœãƒƒãƒˆãŒæ­£å¸¸ã«èµ·å‹•ã—ã¾ã—ãŸï¼')

# ============================================
# ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã®å®šç¾©
# ============================================

# /roulette ã‚³ãƒãƒ³ãƒ‰ã®å®šç¾©
@bot.tree.command(name="roulette", description="ãƒ­ã‚·ã‚¢ãƒ³ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚’é–‹å§‹ã—ã¾ã™")
@app_commands.describe(
    # å„å¼•æ•°ã®èª¬æ˜ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã†ã¨ãã«è¡¨ç¤ºã•ã‚Œã‚‹ï¼‰
    player1="å‚åŠ è€…1 (å¿…é ˆ)",
    player2="å‚åŠ è€…2 (å¿…é ˆ)", 
    player3="å‚åŠ è€…3 (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)",
    player4="å‚åŠ è€…4 (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)",
    player5="å‚åŠ è€…5 (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)",
    player6="å‚åŠ è€…6 (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)",
    player7="å‚åŠ è€…7 (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)",
    player8="å‚åŠ è€…8 (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)",
    player9="å‚åŠ è€…9 (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)",
    player10="å‚åŠ è€…10 (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)"
)
async def start_roulette(interaction: discord.Interaction, 
                        player1: discord.Member,
                        player2: discord.Member,
                        player3: discord.Member = None,
                        player4: discord.Member = None,
                        player5: discord.Member = None,
                        player6: discord.Member = None,
                        player7: discord.Member = None,
                        player8: discord.Member = None,
                        player9: discord.Member = None,
                        player10: discord.Member = None):
    """
    ãƒ­ã‚·ã‚¢ãƒ³ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚’é–‹å§‹ã™ã‚‹ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰
    
    Parameters:
    - interaction: Discordã‹ã‚‰ã®æ“ä½œæƒ…å ±
    - player1, player2: å¿…é ˆå‚åŠ è€…
    - player3-10: ã‚ªãƒ—ã‚·ãƒ§ãƒ³å‚åŠ è€…
    """
    
    # ============================================
    # ã‚²ãƒ¼ãƒ é–‹å§‹å‰ã®ãƒã‚§ãƒƒã‚¯
    # ============================================
    
    # ã™ã§ã«ã‚²ãƒ¼ãƒ ãŒé€²è¡Œä¸­ã‹ãƒã‚§ãƒƒã‚¯
    if game.is_active:
        # ephemeral=True ã§ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å®Ÿè¡Œè€…ã«ã®ã¿è¦‹ãˆã‚‹
        await interaction.response.send_message("âŒ ã™ã§ã«ã‚²ãƒ¼ãƒ ãŒé€²è¡Œä¸­ã§ã™ï¼", ephemeral=True)
        return  # é–¢æ•°ã‚’çµ‚äº†
    
    # ============================================
    # å‚åŠ è€…ãƒªã‚¹ãƒˆã®ä½œæˆã¨æ•´ç†
    # ============================================
    
    # å¿…é ˆå‚åŠ è€…ï¼ˆplayer1, player2ï¼‰ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ 
    players = [player1, player2]
    
    # ã‚ªãƒ—ã‚·ãƒ§ãƒ³å‚åŠ è€…ã®ãƒªã‚¹ãƒˆã‚’ä½œæˆ
    optional_players = [player3, player4, player5, player6, player7, player8, player9, player10]
    
    # ã‚ªãƒ—ã‚·ãƒ§ãƒ³å‚åŠ è€…ã®ä¸­ã§Noneï¼ˆæœªé¸æŠï¼‰ã§ãªã„ã‚‚ã®ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ 
    for player in optional_players:
        if player is not None:  # å‚åŠ è€…ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆ
            players.append(player)
    
    # ============================================
    # é‡è¤‡ãƒã‚§ãƒƒã‚¯ã¨ç„¡åŠ¹ãªå‚åŠ è€…ã®é™¤å¤–
    # ============================================
    
    # é‡è¤‡ã‚’é¿ã‘ã‚‹ãŸã‚ã®å‡¦ç†
    unique_players = []     # é‡è¤‡ã®ãªã„å‚åŠ è€…ãƒªã‚¹ãƒˆ
    seen_ids = set()        # ã™ã§ã«è¿½åŠ ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®IDã‚’è¨˜éŒ²
    
    for player in players:
        # åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¤‡æ•°å›é¸æŠã•ã‚Œã¦ã„ãªã„ã‹ & ãƒœãƒƒãƒˆè‡ªèº«ãŒé¸æŠã•ã‚Œã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
        if player.id not in seen_ids and player != bot.user:
            unique_players.append(player)
            seen_ids.add(player.id)  # ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¨˜éŒ²
    
    # å‚åŠ è€…ãŒ2äººæœªæº€ã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼
    if len(unique_players) < 2:
        await interaction.response.send_message("âŒ æœ€ä½2äººã®ç•°ãªã‚‹å‚åŠ è€…ãŒå¿…è¦ã§ã™ï¼", ephemeral=True)
        return
    
    
    # ============================================
    # ã‚²ãƒ¼ãƒ é–‹å§‹å‡¦ç†
    # ============================================
    
    # Discord.Member ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰è¡¨ç¤ºåï¼ˆãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼‰ã‚’å–å¾—
    player_names = [player.display_name for player in unique_players]
    
    # ã‚²ãƒ¼ãƒ ã‚¯ãƒ©ã‚¹ã§ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ï¼ˆå®Ÿå¼¾ä½ç½®æ±ºå®šã€é †ç•ªã‚·ãƒ£ãƒƒãƒ•ãƒ«ãªã©ï¼‰
    game.start_game(player_names)
    
    # ============================================
    # é–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä½œæˆã¨é€ä¿¡
    # ============================================
    
    # Embedãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆè£…é£¾ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰ã‚’ä½œæˆ
    embed = discord.Embed(
        title="ğŸ¯ ãƒ­ã‚·ã‚¢ãƒ³ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆé–‹å§‹ï¼",
        description=f"å‚åŠ è€…: {', '.join(player_names)}\n\n6ç™ºä¸­1ç™ºãŒå®Ÿå¼¾ã§ã™...",
        color=discord.Color.red()  # èµ¤è‰²ã®ãƒ†ãƒ¼ãƒ
    )
    
    # ãƒ«ãƒ¼ãƒ«èª¬æ˜ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
    embed.add_field(
        name="ãƒ«ãƒ¼ãƒ«",
        value="é †ç•ªã«å¼•ãé‡‘ã‚’å¼•ãã¾ã™ã€‚å®Ÿå¼¾ã‚’å¼•ã„ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè² ã‘ã§ã™ï¼",
        inline=False  # ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ¨ªä¸¦ã³ã«ã—ãªã„
    )
    
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
    await interaction.response.send_message(embed=embed)
    
    # ============================================
    # ã‚²ãƒ¼ãƒ é€²è¡Œé–‹å§‹
    # ============================================
    await play_roulette(interaction)

async def play_roulette(interaction):
    """
    ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚²ãƒ¼ãƒ ã®é€²è¡Œã‚’ç®¡ç†ã™ã‚‹é–¢æ•°
    å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒé †ç•ªã«å¼•ãé‡‘ã‚’å¼•ãã€å‹æ•—ãŒæ±ºã¾ã‚‹ã¾ã§ç¹°ã‚Šè¿”ã™
    
    Parameters:
    - interaction: Discordã‹ã‚‰ã®æ“ä½œæƒ…å ±ï¼ˆãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ç”¨ï¼‰
    """
    round_num = 1  # ç¾åœ¨ã®ãƒ©ã‚¦ãƒ³ãƒ‰æ•°
    
    # ã‚²ãƒ¼ãƒ ãŒé€²è¡Œä¸­ ã‹ã¤ å‚åŠ è€…ãŒ2äººä»¥ä¸Šã„ã‚‹é™ã‚Šç¶šè¡Œ
    while game.is_active and len(game.players) > 1:
        
        # ============================================
        # ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å–å¾—
        # ============================================
        current_player = game.players[0]  # å…ˆé ­ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³
        
        # ============================================
        # ã‚¿ãƒ¼ãƒ³é–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä½œæˆ
        # ============================================
        embed = discord.Embed(
            title=f"ğŸ¯ ç¬¬{round_num}ãƒ©ã‚¦ãƒ³ãƒ‰",
            description=f"**{current_player}** ã®ç•ªã§ã™ï¼",
            color=discord.Color.orange()  # ã‚ªãƒ¬ãƒ³ã‚¸è‰²ã§ç·Šå¼µæ„Ÿã‚’æ¼”å‡º
        )
        
        # ç¾åœ¨ã®çŠ¶æ³ã‚’è¡¨ç¤ºã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
        embed.add_field(
            name="æ®‹ã‚Šå‚åŠ è€…",
            value=f"{len(game.players)}äºº: {', '.join(game.players)}",
            inline=False  # æ¨ªä¸¦ã³ã«ã—ãªã„
        )
        embed.add_field(
            name="ãƒãƒ£ãƒ³ãƒãƒ¼",
            value=f"{game.current_chamber}/{game.max_chambers}",
            inline=True  # æ¨ªä¸¦ã³ã«ã™ã‚‹ï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤ºï¼‰
        )
        
        # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ï¼ˆfollowupã¯æœ€åˆã®responseå¾Œã«ä½¿ç”¨ï¼‰
        await interaction.followup.send(embed=embed)
        
        # ç·Šå¼µæ„Ÿã‚’æ¼”å‡ºã™ã‚‹ãŸã‚ã®2ç§’å¾…æ©Ÿ
        await asyncio.sleep(2)
        
        # ============================================
        # å¼•ãé‡‘ã‚’å¼•ãå‡¦ç†
        # ============================================
        is_bullet = game.pull_trigger()  # Gameã‚¯ãƒ©ã‚¹ã®ãƒ¡ã‚½ãƒƒãƒ‰ã§True/Falseã‚’åˆ¤å®š
        
        if is_bullet:
            # ============================================
            # å®Ÿå¼¾ã‚’å¼•ã„ãŸå ´åˆã®å‡¦ç†ï¼ˆã‚²ãƒ¼ãƒ çµ‚äº†ï¼‰
            # ============================================
            
            # æ•—åŒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä½œæˆ
            embed = discord.Embed(
                title="ğŸ’¥ BANG!",
                description=f"**{current_player}** ãŒå®Ÿå¼¾ã‚’å¼•ãã¾ã—ãŸï¼",
                color=discord.Color.dark_red()  # æ¿ƒã„èµ¤è‰²ã§å±é™ºã‚’è¡¨ç¾
            )
            embed.add_field(
                name="ã‚²ãƒ¼ãƒ çµ‚äº†",
                value=f"**{current_player}** ã®è² ã‘ã§ã™ï¼",
                inline=False
            )
            
            # å‹è€…ã®ç™ºè¡¨
            if len(game.players) > 2:
                # 3äººä»¥ä¸Šã®å ´åˆã¯ã€Œç”Ÿå­˜è€…ã€ã¨ã—ã¦è¡¨ç¤º
                winners = [p for p in game.players if p != current_player]
                embed.add_field(
                    name="ğŸ† ç”Ÿå­˜è€…",
                    value=f"{', '.join(winners)}",
                    inline=False
                )
            else:
                # 2äººã®å ´åˆã¯ã€Œå‹è€…ã€ã¨ã—ã¦è¡¨ç¤º
                winner = [p for p in game.players if p != current_player][0]
                embed.add_field(
                    name="ğŸ† å‹è€…",
                    value=f"**{winner}**",
                    inline=False
                )
            
            # ã‚²ãƒ¼ãƒ çµ‚äº†å‡¦ç†
            await interaction.followup.send(embed=embed)
            game.reset()  # ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            return  # é–¢æ•°ã‚’çµ‚äº†ã—ã¦ã‚²ãƒ¼ãƒ ã‚’å®Œå…¨ã«çµ‚äº†
            
        else:
            # ============================================
            # ç©ºç ²ã®å ´åˆã®å‡¦ç†ï¼ˆã‚²ãƒ¼ãƒ ç¶™ç¶šï¼‰
            # ============================================
            
            # ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä½œæˆ
            embed = discord.Embed(
                title="ğŸ”« ã‚«ãƒãƒƒ...",
                description=f"**{current_player}** ã¯ã‚»ãƒ¼ãƒ•ï¼",
                color=discord.Color.green()  # ç·‘è‰²ã§å®‰å…¨ã‚’è¡¨ç¾
            )
            await interaction.followup.send(embed=embed)
            
            # ============================================
            # æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã®æº–å‚™
            # ============================================
            
            # ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ãƒªã‚¹ãƒˆã®æœ€å¾Œã«ç§»å‹•ï¼ˆé †ç•ªã‚’å›ã™ï¼‰
            game.players.append(game.players.pop(0))
            round_num += 1  # ãƒ©ã‚¦ãƒ³ãƒ‰æ•°ã‚’å¢—åŠ 
            
            # æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¾ã§ã®é–“éš”ã‚’è¨­ã‘ã‚‹
            await asyncio.sleep(1.5)

# ============================================
# ãã®ä»–ã®ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰
# ============================================

@bot.tree.command(name="stop", description="é€²è¡Œä¸­ã®ãƒ­ã‚·ã‚¢ãƒ³ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚’åœæ­¢ã—ã¾ã™")
async def stop_roulette(interaction: discord.Interaction):
    """
    é€²è¡Œä¸­ã®ã‚²ãƒ¼ãƒ ã‚’å¼·åˆ¶åœæ­¢ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰
    ã‚²ãƒ¼ãƒ ãŒé€²è¡Œä¸­ã§ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    """
    
    # ã‚²ãƒ¼ãƒ ãŒé€²è¡Œä¸­ã§ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
    if not game.is_active:
        await interaction.response.send_message("âŒ é€²è¡Œä¸­ã®ã‚²ãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“ã€‚", ephemeral=True)
        return
    
    # ã‚²ãƒ¼ãƒ ã‚’åœæ­¢ã—ã¦ãƒªã‚»ãƒƒãƒˆ
    game.reset()
    
    # åœæ­¢å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
    embed = discord.Embed(
        title="â›” ã‚²ãƒ¼ãƒ åœæ­¢",
        description="ãƒ­ã‚·ã‚¢ãƒ³ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆãŒåœæ­¢ã•ã‚Œã¾ã—ãŸã€‚",
        color=discord.Color.blue()  # é’è‰²ã§æƒ…å ±ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¾
    )
    await interaction.response.send_message(embed=embed)

@bot.tree.command(name="rules", description="ãƒ­ã‚·ã‚¢ãƒ³ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®ãƒ«ãƒ¼ãƒ«ã‚’è¡¨ç¤ºã—ã¾ã™")
async def roulette_rules(interaction: discord.Interaction):
    """
    ãƒ«ãƒ¼ãƒ«ã¨ã‚³ãƒãƒ³ãƒ‰ã®ä½¿ã„æ–¹ã‚’è¡¨ç¤ºã™ã‚‹ã‚³ãƒãƒ³ãƒ‰
    åˆå¿ƒè€…å‘ã‘ã«ã‚²ãƒ¼ãƒ ã®èª¬æ˜ã‚’æä¾›
    """
    
    # ãƒ«ãƒ¼ãƒ«èª¬æ˜ç”¨ã®Embedãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
    embed = discord.Embed(
        title="ğŸ¯ ãƒ­ã‚·ã‚¢ãƒ³ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ ãƒ«ãƒ¼ãƒ«",
        color=discord.Color.blue()  # é’è‰²ã§æƒ…å ±ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¾
    )
    
    # åŸºæœ¬ãƒ«ãƒ¼ãƒ«ã®èª¬æ˜
    embed.add_field(
        name="åŸºæœ¬ãƒ«ãƒ¼ãƒ«",
        value="6ç™ºã®ã†ã¡1ç™ºãŒå®Ÿå¼¾ã§ã™ã€‚é †ç•ªã«å¼•ãé‡‘ã‚’å¼•ãã€å®Ÿå¼¾ã‚’å¼•ã„ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè² ã‘ã§ã™ã€‚",
        inline=False  # ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ¨ªä¸¦ã³ã«ã—ãªã„
    )
    
    # åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰ã®èª¬æ˜
    embed.add_field(
        name="ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰",
        value="`/roulette` - ã‚²ãƒ¼ãƒ é–‹å§‹ (å‚åŠ è€…ã‚’é¸æŠ)\n`/stop` - ã‚²ãƒ¼ãƒ åœæ­¢\n`/rules` - ãƒ«ãƒ¼ãƒ«è¡¨ç¤º",
        inline=False
    )
    
    # å‚åŠ è€…æ•°ã®åˆ¶é™
    embed.add_field(
        name="å‚åŠ è€…æ•°",
        value="æœ€ä½2äººã€œæœ€å¤§10äºº",
        inline=True  # ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã«è¡¨ç¤º
    )
    
    # ãƒ«ãƒ¼ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€ä¿¡
    await interaction.response.send_message(embed=embed)

# ============================================
# ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
# ============================================

@bot.event
async def on_app_command_error(interaction: discord.Interaction, error: app_commands.AppCommandError):
    """
    ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸéš›ã®å‡¦ç†
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ã‹ã‚Šã‚„ã™ã„ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    """
    
    if isinstance(error, app_commands.CommandOnCooldown):
        # ã‚³ãƒãƒ³ãƒ‰ä½¿ç”¨åˆ¶é™ã‚¨ãƒ©ãƒ¼ã®å ´åˆ
        await interaction.response.send_message(
            f"âŒ ã‚³ãƒãƒ³ãƒ‰ã¯ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ä¸­ã§ã™ã€‚{error.retry_after:.1f}ç§’å¾Œã«å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚",
            ephemeral=True  # å®Ÿè¡Œè€…ã«ã®ã¿è¡¨ç¤º
        )
    elif isinstance(error, app_commands.MissingPermissions):
        # æ¨©é™ä¸è¶³ã‚¨ãƒ©ãƒ¼ã®å ´åˆ
        await interaction.response.send_message(
            "âŒ ã“ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚",
            ephemeral=True
        )
    else:
        # ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ã®å ´åˆ
        embed = discord.Embed(
            title="âŒ ã‚¨ãƒ©ãƒ¼",
            description=f"ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(error)}",
            color=discord.Color.red()  # èµ¤è‰²ã§ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¾
        )
        
        # ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ¸ˆã¿ã‹ã©ã†ã‹ã§é€ä¿¡æ–¹æ³•ã‚’å¤‰ãˆã‚‹
        if interaction.response.is_done():
            # ã™ã§ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ¸ˆã¿ã®å ´åˆã¯followupã‚’ä½¿ç”¨
            await interaction.followup.send(embed=embed, ephemeral=True)
        else:
            # ã¾ã ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã—ã¦ã„ãªã„å ´åˆã¯é€šå¸¸ã®responseã‚’ä½¿ç”¨
            await interaction.response.send_message(embed=embed, ephemeral=True)

# ============================================
# ãƒœãƒƒãƒˆèµ·å‹•å‡¦ç†
# ============================================

# ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒç›´æ¥å®Ÿè¡Œã•ã‚ŒãŸå ´åˆã®ã¿ãƒœãƒƒãƒˆã‚’èµ·å‹•
# ï¼ˆä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰importã•ã‚ŒãŸå ´åˆã¯èµ·å‹•ã—ãªã„ï¼‰
if __name__ == "__main__":
    # ç’°å¢ƒå¤‰æ•°ã‹ã‚‰Discordãƒœãƒƒãƒˆã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
    token = os.getenv('DISCORD_TOKEN')
    
    # ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if not token:
        print("âŒ DISCORD_TOKENãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼")
        print(".envãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚")
    else:
        # ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãƒœãƒƒãƒˆã‚’èµ·å‹•
        print("ğŸš€ ãƒœãƒƒãƒˆã‚’èµ·å‹•ã—ã¦ã„ã¾ã™...")
        bot.run(token)
